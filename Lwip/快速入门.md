

# 以太网

- 以太网将数据一层一层打包，数据传输稳定，成本低
- 但是**以太网≠互联网**，以太网只是互联网的一种
- 使用TCP/IP协议进行通信

# TCP/IP

- TCP/IP (Transmission Control Protocol/Internet Protocol)是一个庞大的协议族（TCP和IP只是其中两个协议），它是众多网络协议的集合，包括：ARP、**IP**、ICMP、UDP、**TCP**、DNS、DHCP、HTTP、FTP、MQTT等等

- 低层协议为相邻的上层协议提供服务，是上层协议得以实现的基础

# 网络分层

![image-20250417155957912](https://raw.githubusercontent.com/ZhangZhen-huia/Note/main/img/202504171559012.png)***嵌入式stm32主要是五层模型***



![image-20250417160150836](https://raw.githubusercontent.com/ZhangZhen-huia/Note/main/img/202504171601904.png)

- 把首部可以简单理解为一个标记（传输数据就像发快递，发的时候需要备注：发的什么，发到哪里），应用层就是把用户数据进行分类然后给出标记（应用层首部），打包发到传输层
- 发送消息肯定是要用相同的通讯方式，所以就需要一个端口，实现端到端的通信，一个电脑上有很多程序，不同程序有各自的端口，所以在TCP/UDP首部做上端口标记后打包给网络层
- 网络层也叫IP层，用于主机和主机进行通信，网络层就是给这一包数据附了一个IP地址（IP首部中不只包含IP信息），打包后送到链路层
- 用于把数据分割成一帧一帧的数据，例如你发送了一个1M字节的信息，那么链路层就会给这一包数据分割成一帧一帧的数据发送出去，一帧数据为（46-1500个字节）,加上以太网首部（包含MAC地址）和尾部，形成“以太网帧”，数据一帧一帧送给物理层发送出去
- 物理层把01数据翻译成高低电平通过网线传输

![image-20250417160201028](https://raw.githubusercontent.com/ZhangZhen-huia/Note/main/img/202504171602098.png)

- 另一台机器的物理层收到高低电平数据，将其翻译回01数据发给链路层
- 链路层检查以太网首部的MAC地址，确认是发给自己的，那就会把一帧一帧的数据组合起来，然后检查数据是否正常，正常的话就去掉以太网首部和尾部，发给网络层
- 网络层（IP层）确认之后拆掉IP首部之后再传到传输层
- 传输层确认端口号之后拆掉首部传到应用层
- 应用层检查应用层首部中的标记，把不同类型的消息分别解读出来，比如图片和音频还是文字，解读完之后去掉首部就成为了用户数据

# LWIP

***Light weight IP，一个轻量化的 免费的开源TCP/IP 协议***

***与TCP/IP的区别***

- 是TCP/IP的裁剪版
- RTOS和裸机都可以跑
- LwIP 并没有采用很明确的分层结构，它假设各层之间的部分数据和结构体和实现原理在其他层是可见的，简单来说就传输层知道 IP 层是如何封装数据、传递数据的， IP 层知道链路层是怎么封装数据的等等，可以实现内存区域共用，极力避免数据拷贝，尽可能减少占用

LWIP协议栈：简单理解为库

# 三次握手四次挥手

TCP是一对一的连接，需要确定连接的可靠性

- 三次握手用于连接的建立
  - 三次握手类似于IIC的ACK，A发起请求，B应答，不过TCP多了一次交流，A最好发起交流信号
- 四次挥手用于连接的断开
  - A发起断开请求
  - B表示信息还没有传输完成，拒绝断开
  - B表示传输完成，可以断开
  - A回应B，然后等待2ms，如果收到B的释放信号，那就把连接断开
  - 如果B没收到第四次挥手，就会重复发送第三次的释放信号，A发完后会停留2毫秒，如果还受到了B的第三次挥手信号，说明B没收到第四次挥手，这时候会A会再次重复第四次挥手

# 硬件支持

## 有ETH外设

就说明芯片里面是有MAC层即链路层，芯片可以通过 DMA 控制器进行介质访问控制(MAC) 实现 MAC 层的任务，通过 ETH 外设可以按照 IEEE 802.3-2002 标准发送和接收 MAC 数据包

所以我们需要物理层

即需要外置一个在物理层里面工作的芯片（PHY）

PHY和STM32通信需要一个接口，如MII、RMII

![image-20250417164144216](https://raw.githubusercontent.com/ZhangZhen-huia/Note/main/img/202504171641278.png)

## 无ETH外设

W5500，这个芯片同时集成了MAC层和PHY层的功能，MAC层数据通过SPI传输进STM32芯片。

# [参考博客](https://blog.csdn.net/lrqblack/article/details/123842063)

